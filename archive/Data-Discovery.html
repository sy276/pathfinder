<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Data Discovery v3">
    <meta name="author" content="sid">
    <title>Data Discovery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous">
        </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="icon" type="image/svg+xml"
        href='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22999%22%20height%3D%22999%22%20fill%3D%22white%22%20class%3D%22bi%20bi-bounding-box-circles%22%0A%20%20%20%20viewBox%3D%220%200%2016%2016%22%3E%0A%20%20%20%20%3Cline%20x1%3D%222.5%22%20y1%3D%2213.5%22%20x2%3D%2214%22%20y2%3D%228%22%20style%3D%22stroke%3A%237D7D7D%3Bstroke-width%3A0.8%22%20%2F%3E%0A%20%20%20%20%3Cline%20x1%3D%225%22%20y1%3D%221.7%22%20x2%3D%222.5%22%20y2%3D%2213.5%22%20style%3D%22stroke%3A%237D7D7D%3Bstroke-width%3A0.8%22%20%2F%3E%0A%20%20%20%20%3Cline%20x1%3D%2214%22%20y1%3D%228%22%20x2%3D%225%22%20y2%3D%221.7%22%20style%3D%22stroke%3A%237D7D7D%3Bstroke-width%3A0.8%22%20%2F%3E%0A%20%20%20%20%3Ccircle%20cx%3D%222.5%22%20cy%3D%2213.5%22%20r%3D%222.5%22%20fill%3D%22%23f46332%22%20%2F%3E%0A%20%20%20%20%3Ccircle%20cx%3D%225%22%20cy%3D%221.7%22%20r%3D%221.7%22%20fill%3D%22%23ff6b6b%22%20%2F%3E%0A%20%20%20%20%3Ccircle%20cx%3D%2214%22%20cy%3D%228%22%20r%3D%222.0%22%20fill%3D%22%23ffc800%22%20%2F%3E%0A%3C%2Fsvg%3E' />
    <style>
        .table-sm td,
        .table-sm th {
            padding: 0.0rem;
        }
    </style>
</head>

<body>
    <form>
        <div class="row g-3" style="margin-left: 1%; margin-right: 1%; margin-top: 1%;">
            <div class="col-md-4">
                <label for="JSONFile3" class="form-label"><strong>Classes</strong> JSON</label>
                <div class="input-group mb-3">
                    <input class="form-control border border-secondary" type="file" id="JSONFile3" accept=".json">
                    <input type="button" class="btn btn-primary border border-secondary" id="JSONFile3Upload"
                        onclick="readJsonFile('JSONFile3', 'JSONFile3Uploaded')" value="Attach" />
                </div>
                <span class="badge rounded-pill text-bg-success" id="JSONFile3Uploaded"></span>
            </div>

            <div class="col-md-4">
                <label for="JSONFile1" class="form-label"><strong>All Fields</strong> JSON</label>
                <div class="input-group mb-3">
                    <input class="form-control border border-secondary" type="file" id="JSONFile1" accept=".json">
                    <input type="button" class="btn btn-primary border border-secondary" id="JSONFile1Upload"
                        onclick="readJsonFile('JSONFile1', 'JSONFile1Uploaded')" value="Attach" />
                </div>
                <span class="badge rounded-pill text-bg-success" id="JSONFile1Uploaded"></span>
            </div>

            <div class="col-md-4">
                <label for="JSONFile2" class="form-label"><strong>All Data Sources</strong> JSON</label>
                <div class="input-group mb-3">
                    <input class="form-control border border-secondary" type="file" id="JSONFile2" accept=".json">
                    <input type="button" class="btn btn-primary border border-secondary" id="JSONFile2Upload"
                        onclick="readJsonFile('JSONFile2', 'JSONFile2Uploaded')" value="Attach" />
                </div>
                <span class="badge rounded-pill text-bg-success" id="JSONFile2Uploaded"></span>
            </div>
        </div>
        <div class="row g-3" style="margin-left: 1%; margin-right: 1%; margin-top: 0.25%;">
            <div class="col-md-4">
                <label class="form-label"><strong>Target</strong> BO</label>
                <div class="input-group mb-3">
                    <input type="text" class="form-control border border-secondary" placeholder="Worker"
                        id="TargetBusinessObject">
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label"><strong>Source</strong> BO</label>
                <div class="input-group mb-3">
                    <input type="text" class="form-control border border-secondary" placeholder="Dependent"
                        id="SourceBusinessObject">
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label"><strong>Depth</strong> Level</label>
                <div class="input-group mb-3">
                    <input type="number" class="form-control border border-secondary" placeholder="2" id="DepthLevel">
                </div>
            </div>
        </div>
        <div class="row g-3" style="margin-left: 1.5%; margin-right: 1.5%; margin-top: 0.25%;">
            <input type="button" class="btn btn-primary border border-secondary" id="GetBusinessObjectRelationships"
                onclick="getBoRelationships()" value="Get Business Object Relationships">
        </div>
        <div class="row g-3" style="margin-left: 1%; margin-right: 1%; margin-top: 1%;">
            <div>
                <label for="BODropdown" class="form-label"><strong>BO</strong> Traversal Path</label>
                <div class="input-group mb-3">
                    <select class="form-select border border-secondary" aria-label="BO Dropdown" id="BODropdown"
                        onchange="getFieldRelationships()">
                        <option selected>Nothing to display. Click on "Get Business Object Relationships".</option>
                    </select>
                </div>
            </div>
            <div>
                <label for="FieldDropdown" class="form-label"><strong>BO-Field</strong> Traversal Path</label>
                <div class="input-group mb-3">
                    <select class="form-select border border-secondary" aria-label="Field Dropdown" id="FieldDropdown"
                        onchange="getCalcFields()">
                        <option selected>Nothing to display. Click on "Get Business Object Relationships".</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="card border" id="CalcFieldsCard" style="display: none; margin: 1%;">
            <h6 class="card-header border border-secondary"><b>Calculated Fields</b></h6>
            <div class="card-body border border-secondary">
                <p class="card-text" id="CalcFields"></p>
            </div>
        </div>
    </form>
</body>

<script type="text/javascript">
    var dl;
    var bo;
    var rbo;
    var jsondata;
    var paths = [];
    var fieldsjsonfile = new Object();
    var datasourcesjsonfile = new Object();
    var classesjsonfile = new Object();
    function validateData() {
        var bool = true;
        if (dl < 2 || dl.indexOf(' ') >= 0) {
            bool = false;
            alert("Depth Level should be >=2");
        }
        if (bo == rbo || bo == null || rbo == null || bo == "" || rbo == "") {
            bool = false;
            alert("Target and Source BOs must be populated and must be unique");
        }
        try {
            if (jsondata[0].F && jsondata[0].B && jsondata[0].R) {
            }
            else {
                bool = false;
                alert("Attach at least one JSON File");
            }
        }
        catch (e) {
            bool = false;
            alert("Attach at least one JSON File");
        }
        if (bool == true) {
            const links = [];
            for (var i = 0; i < jsondata.length; i++) {
                links.push(Object.values([jsondata[i].B, jsondata[i].R]));
            }
            findPaths(links, bo, rbo, dl);
        }
    }
    function readJsonFile(jf, jfud) {
        const file = document.getElementById(jf).files[0];
        const reader = new FileReader;
        reader.readAsText(file, 'UTF-8');
        reader.addEventListener("load", () => {
            try {
                if (jf == "JSONFile1") {
                    var parsejson = JSON.parse(reader.result);
                    if (parsejson.Report_Entry[0].R != '' && parsejson.Report_Entry[0].R != undefined) {
                        fieldsjsonfile = parsejson.Report_Entry;
                        document.getElementById(jfud).innerHTML = file.name + ' attached';
                    }
                    else {
                        fieldsjsonfile = {};
                        alert("Attach properly formatted All Fields JSON File");
                        document.getElementById(jfud).innerHTML = '';
                    }
                }
                else if (jf == "JSONFile2") {
                    let filedata = JSON.parse(reader.result);
                    let result = [];
                    if (Array.isArray(filedata.Report_Entry)) {
                        filedata.Report_Entry.forEach(entry => {
                            const baseValue = entry.B;
                            if (Array.isArray(entry.R_G)) {
                                entry.R_G.forEach(group => {
                                    if (group.R && group.F) {
                                        result.push({
                                            B: baseValue,
                                            R: group.R,
                                            F: group.F
                                        });
                                    }
                                });
                            }
                        });
                    }
                    let parsejson = { Report_Entry: result };
                    if (parsejson.Report_Entry[0].R != '' && parsejson.Report_Entry[0].R != undefined) {
                        datasourcesjsonfile = parsejson.Report_Entry;
                        document.getElementById(jfud).innerHTML = file.name + ' attached';
                    }
                    else {
                        datasourcesjsonfile = {};
                        alert("Attach properly formatted All Data Sources JSON File");
                        document.getElementById(jfud).innerHTML = '';
                    }
                }
                else {
                    let filedata = JSON.parse(reader.result);
                    let result = [];
                    if (Array.isArray(filedata.Report_Entry)) {
                        filedata.Report_Entry.forEach(entry => {
                            const baseValue = entry.B;
                            if (Array.isArray(entry.R_G)) {
                                entry.R_G.forEach(group => {
                                    if (group.R && group.F) {
                                        result.push({
                                            B: baseValue,
                                            R: group.R,
                                            F: group.F
                                        });
                                    }
                                });
                            }
                        });
                    }
                    let parsejson = { Report_Entry: result };
                    if (parsejson.Report_Entry[0].R != '' && parsejson.Report_Entry[0].R != undefined) {
                        classesjsonfile = parsejson.Report_Entry;
                        document.getElementById(jfud).innerHTML = file.name + ' attached';
                    }
                    else {
                        classesjsonfile = {};
                        alert("Attach properly formatted Classes JSON File");
                        document.getElementById(jfud).innerHTML = '';
                    }
                }
            }
            catch (e) {
                if (jf == "JSONFile1") {
                    fieldsjsonfile = {};
                }
                else if (jf == "JSONFile2") {
                    datasourcesjsonfile = {};
                }
                else {
                    classesjsonfile = {};
                }
                alert("Attach a properly formatted JSON file");
                document.getElementById(jfud).innerHTML = '';
            }
            finally { updateJsonData(); }
        }, false);
    }
    function getBoRelationships() {
        paths = [];
        bo = document.getElementById('TargetBusinessObject').value.trim();
        rbo = document.getElementById('SourceBusinessObject').value.trim();
        dl = document.getElementById('DepthLevel').value.trim();
        validateData();
        updateBoDropdown();
    }
    function updateJsonData() {
        var fjf = (JSON.stringify(fieldsjsonfile).trim()).substring(1);
        var djf = (JSON.stringify(datasourcesjsonfile).trim()).substring(1);
        var cjf = (JSON.stringify(classesjsonfile).trim()).substring(1);
        fjf = fjf.substring(0, fjf.length - 1);
        djf = djf.substring(0, djf.length - 1);
        cjf = cjf.substring(0, cjf.length - 1);
        if ((fjf != null & fjf != '' & djf != null & djf != '') || (fjf != null & fjf != '' & cjf != null & cjf != '')) {
            fjf = fjf + ',';
        }
        if (djf != null & djf != '' & cjf != null & cjf != '') {
            djf = djf + ',';
        }
        jsondata = '[' + fjf + djf + cjf + ']';
        jsondata = jsondata.split('"B":');
        jsondata = [...new Set(jsondata)];
        jsondata = jsondata.join('"B":')
        jsondata = JSON.parse(jsondata);

        let B_values = jsondata.map(obj => obj.B);
        let R_values = jsondata.map(obj => obj.R);
        let allbos = [...new Set([...B_values, ...R_values])].sort();
        $(function () {
            function applyAutocomplete(id) {
                $(id).autocomplete({
                    source: function (request, response) {
                        var matcherStart = new RegExp("^" + $.ui.autocomplete.escapeRegex(request.term), "i");
                        var matcherContain = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                        var relevantItemsStart = allbos.filter(item => matcherStart.test(item));
                        var relevantItemsContain = allbos.filter(item => !matcherStart.test(item) && matcherContain.test(item));
                        response(relevantItemsStart.concat(relevantItemsContain).sort(function (a, b) {
                            var aStartsWith = a.toLowerCase().startsWith(request.term.toLowerCase());
                            var bStartsWith = b.toLowerCase().startsWith(request.term.toLowerCase());
                            if (aStartsWith && !bStartsWith) {
                                return -1;
                            } else if (!aStartsWith && bStartsWith) {
                                return 1;
                            } else {
                                return a.localeCompare(b);
                            }
                        }));
                    }
                });
            }
            applyAutocomplete("#TargetBusinessObject");
            applyAutocomplete("#SourceBusinessObject");
        });
    }
    function findPaths(links, start, end, depth) {
        const graph = links.reduce((map, [start, end]) => {
            if (map.has(start)) {
                map.get(start).push([end])
            } else {
                map.set(start, [[end]])
            }
            return map
        }, new Map())
        const find = (start, currentPath = [start]) => {
            if (graph.get(start)) {
                for (const [destination] of graph.get(start)) {
                    var newPath = currentPath;
                    if (destination === end) {
                        newPath = currentPath.concat(destination);
                        if (!paths.includes(newPath.join(' --> '))) {
                            paths.push(newPath.join(' --> '));
                        }
                    } else {
                        if ((newPath.length < depth - 1) && (!newPath.includes(destination))) {
                            newPath = currentPath.concat(destination);
                            find(destination, newPath);
                        }
                    }
                }
            }
        };
        find(start);
        paths.sort();
    }
    function updateBoDropdown() {
        const bodropdown = document.querySelector('#BODropdown');
        bodropdown.options.length = 0;
        if (paths.length > 0) {
            paths.forEach(paths => {
                bodropdown.innerHTML += `<option value="${paths}">${paths}</option>`;
            })
        }
        else {
            bodropdown.innerHTML += `<option value="No traversal paths, try with different parameters">No traversal paths, try with different parameters</option>`;
        }
        getFieldRelationships();
    }
    function getFieldRelationships() {
        var fieldrelationships = [];
        var selectedbopath = document.getElementById('BODropdown').value;
        const fielddropdown = document.querySelector('#FieldDropdown');
        fielddropdown.options.length = 0;
        if (selectedbopath == 'No traversal paths, try with different parameters') {
            fielddropdown.innerHTML += `<option value="No traversal paths, try with different parameters">No traversal paths, try with different parameters</option>`;
        }
        else {
            fieldrelationships = (findFeildRelations(selectedbopath, jsondata)).sort();
            fieldrelationships.forEach(fieldrelationships => {
                fielddropdown.innerHTML += `<option value="${fieldrelationships}">${fieldrelationships}</option>`;
            })
        }
        getCalcFields();
    }
    function findFeildRelations(_path, _jsondata) {
        var links = [];
        let shortarray = [];
        let longarray = [];
        var listbo = _path.split(' --> ');
        for (var bo = 0; bo < listbo.length - 1; bo++) {
            for (var i = 0; i < _jsondata.length; i++) {
                if ((listbo[bo] == _jsondata[i]["B"]) && listbo[bo + 1] == _jsondata[i]["R"])
                    links.push(Object.values([_jsondata[i]["B"], _jsondata[i]["F"], _jsondata[i]["R"]]));
            }
        }
        for (var i = 0; i < listbo.length - 1; i++) {
            shortarray = [];
            if (i == 0) {
                shortarray = getBO(listbo[i], true);
            }
            else {
                shortarray = getBO(listbo[i], false);
            }
            longarray[longarray.length] = shortarray;
        }
        function getBO(BO, isParent) {
            for (var i = 0; i < links.length; i++) {
                if (links[i][0] == BO) {
                    if (isParent)
                        shortarray.push(links[i].join(' --> '));
                    else
                        shortarray.push(links[i].slice(1).join(' --> '));
                }
            }
            return shortarray;
        }
        function allPossibilities(longarray) {
            if (longarray.length == 1) {
                return longarray[0];
            } else {
                var result = [];
                var remainingPossibilities = allPossibilities(longarray.slice(1));
                for (var i = 0; i < remainingPossibilities.length; i++) {
                    for (var j = 0; j < longarray[0].length; j++) {
                        result.push(longarray[0][j] + ' --> ' + remainingPossibilities[i]);
                    }
                }
                return result;
            }
        }
        return allPossibilities(longarray);
    }
    function getCalcFields() {
        var cfsteps = "";
        var selectedbofpath = (document.getElementById('FieldDropdown').value).split(' --> ');
        if (selectedbofpath.length > 1) {
            document.getElementById('CalcFieldsCard').style.display = 'block';
            cfsteps = "<table class='table table-hover table-sm table-borderless'><tr><td colspan='2'><b>Start</b></tr></td>";
            var currentfield = selectedbofpath[1];
            var returnfield;
            for (var i = 0; i < (selectedbofpath.length - 1) / 2; i++) {
                returnfield = selectedbofpath[(i * 2) + 3];
                if (returnfield == undefined) {
                    returnfield = "<i>{Name of your Return Field from '" + selectedbofpath[(i * 2) + 2] + "' BO}</i>";
                }
                if (currentfield.indexOf('(Multi-instance)') > 0) {
                    cfsteps = cfsteps +
                        "<tr><td colspan='2' style='border: none;'><hr style='border-top: 1px solid grey;'></td></tr>" + "<tr><td>" + "<b>Full Name</b>" + "</td><td>" + "CF_ESI " + currentfield.replace('CF_LRV ', '') + "</tr></td>" +
                        "<tr><td>" + "<b>Business Object</b> " + "</td><td>" + selectedbofpath[0] + "</tr></td>" +
                        "<tr><td>" + "<b>Function</b>" + "</td><td>" + "Extract Single Instance" + "</tr></td>" +
                        "<tr><td>" + "<b>Source Field</b>" + "</td><td>" + currentfield + "</tr></td>" +
                        "<tr><td>" + "<b>Related Business Object</b>" + "</td><td>" + selectedbofpath[(i * 2) + 2] + "</tr></td>" +
                        "<tr><td>" + "<b>Condition</b>" + "</td><td>" + "<i>Use an existing condition or create a condition on '" + selectedbofpath[(i * 2) + 2] + "' BO</i>" + "</tr></td>" +
                        "<tr><td>" + "<b>Sort Field, Sort Direction</b>" + "</td><td>" + "<i>Enter Sort Field, Sort Direction</i>" + "</tr></td>" +
                        "<tr><td>" + "<b>Instance to be Returned</b>" + "</td><td>" + "<i>Select First occurrence/Last occurrence/Specific occurrence</i>" + "</tr></td>";
                    currentfield = "CF_ESI " + currentfield.replace('CF_LRV ', '');
                }
                cfsteps = cfsteps +
                    "<tr><td colspan='2' style='border: none;'><hr style='border-top: 1px solid grey;'></td></tr>" + "<tr><td>" + "<b>Full Name</b>" + "</td><td>" + "CF_LRV " + returnfield + "</tr></td>" +
                    "<tr><td>" + "<b>Business Object</b>" + "</td><td>" + selectedbofpath[0] + "</tr></td>" +
                    "<tr><td>" + "<b>Function</b>" + "</td><td>" + "Lookup Related Value" + "</tr></td>" +
                    "<tr><td>" + "<b>Lookup Field</b>" + "</td><td>" + currentfield + "</tr></td>" +
                    "<tr><td>" + "<b>Related Business Object</b>" + "</td><td>" + selectedbofpath[(i * 2) + 2] + "</tr></td>" +
                    "<tr><td>" + "<b>Return Value</b>" + "</td><td>" + returnfield + "</tr></td>";
                currentfield = "CF_LRV " + returnfield;
            }
            cfsteps = cfsteps + "<tr><td colspan='2' style='border: none;'><hr style='border-top: 1px solid grey;'></td><tr><td colspan='2'><b>End</b></table></tr></td>";
            cfsteps = cfsteps.replace(/\(Multi-instance\)|\(Single instance\)|\(Self referencing instance\)/g, '');
            document.getElementById('CalcFields').innerHTML = cfsteps;
        }
        else {
            document.getElementById('CalcFieldsCard').style.display = 'none';
        }
    }
</script>